---
import { getLangFromUrl, useTranslations } from '@i18n:utils';
type Props = {
	siteKey: string;
	contactForm: string;
	contactFormToken: string;
};
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Crear un objeto con las traducciones necesarias
const translations = {
	messageSent: t('messageSent'),
	recaptchaError: t('recaptchaError'),
	recaptchaFailed: t('recaptchaFailed'),
	formError: t('formError'),
	formSubmissionFailed: t('formSubmissionFailed'),
};

const { siteKey, contactForm, contactFormToken } = Astro.props;
---

<form
	class="card p-5 space-y-4 bg-neutral text-neutral-content m-auto w-full"
	id="contact-form"
	method="post"
	action="/api/contact"
>
	<div>
		<label for="form-name" class="text-sm font-bold uppercase text-lightest-slate">
			{t('yourFullName')}
		</label>
		<input
			id="form-name"
			class="focus:shadow-outline mt-2 w-full rounded-lg border-2 border-green-500 bg-transparent p-3 text-green-500 focus:outline-none"
			name="name"
			required
			type="text"
			placeholder="John Doe"
		/>
	</div>
	<div class="mt-8">
		<label for="form-email" class="text-sm font-bold uppercase text-lightest-slate">
			{t('yourEmail')}
		</label>
		<input
			id="form-email"
			class="focus:shadow-outline mt-2 w-full rounded-lg border-2 border-green-500 bg-transparent p-3 text-green-500 focus:outline-none"
			placeholder="johndoe@gmail.com"
			name="email"
			required
			type="email"
		/>
	</div>
	<div class="mt-8">
		<label for="form-subject" class="text-sm font-bold uppercase text-lightest-slate">
			{t('subject')}
		</label>
		<input
			id="form-subject"
			class="focus:shadow-outline mt-2 w-full rounded-lg border-2 border-green-500 bg-transparent p-3 text-green-500 focus:outline-none"
			placeholder={t('subjectPlaceholder')}
			name="subject"
			spellcheck="true"
			required
			type="text"
		/>
	</div>
	<div class="mt-8">
		<label for="form-message" class="text-sm font-bold uppercase text-lightest-slate">
			{t('message')}
		</label>
		<textarea
			id="form-message"
			placeholder={t('messagePlaceholder')}
			name="message"
			required
			spellcheck="true"
			class="focus:shadow-outline mt-2 h-32 w-full rounded-lg border-2 border-green-500 bg-transparent p-3 text-green-500 focus:outline-none"
		></textarea>
	</div>
	<div class="mt-8">
		<div id="hcaptcha" class="h-captcha" data-sitekey={siteKey} data-theme="dark"></div>
		<button
			type="submit"
			class="big-button w-full relative disabled:opacity-50 disabled:cursor-not-allowed"
			aria-label={t('sendMessage')}
		>
			<span class="loading-text">{t('sendMessage')}</span>
			<span class="loading-spinner hidden">
				<span
					class="animate-spin inline-block w-4 h-4 border-2 border-t-transparent border-white rounded-full"
				></span>
				{t('sending')}...
			</span>
		</button>
	</div>
</form>

<!-- Toast notification component -->
<div
	id="toast-notification"
	class="fixed top-4 right-4 z-50 invisible opacity-0 transition-all duration-300 ease-in-out"
>
	<div class="flex items-center p-4 rounded-lg shadow-lg min-w-[280px]">
		<div class="flex-1 toast-message"></div>
		<button onclick="closeToast()" class="ml-4">
			<span class="text-2xl">&times;</span>
		</button>
	</div>
</div>

<script is:inline src="https://js.hcaptcha.com/1/api.js" async defer></script>
<!-- 
<script is:inline src="https://www.google.com/recaptcha/api.js" async defer></script>
<script define:vars={{ contactForm, translations, contactFormToken }}>
	const closeToast = () => {
		const toast = document.getElementById('toast-notification');
		toast.classList.remove('visible', 'opacity-100');
		toast.classList.add('invisible', 'opacity-0');
	};

	const showToast = (message, isError = false) => {
		const toast = document.getElementById('toast-notification');
		const toastMessage = toast.querySelector('.toast-message');

		toast.querySelector('div').className =
			`flex items-center p-1 rounded-lg shadow-lg min-w-[280px] border ${
				isError
					? 'border-red-500 bg-red-500/50 text-white'
					: 'border-green-500 bg-green-500/50 text-white'
			}`;

		toastMessage.textContent = message;

		// Mostrar el toast
		toast.classList.remove('invisible', 'opacity-0');
		toast.classList.add('visible', 'opacity-100');

		// Auto ocultar despuÃ©s de 5 segundos
		setTimeout(closeToast, 5000);
	};

	const form = document.getElementById('contact-form');
	const submitButton = form.querySelector('button[type="submit"]');
	const loadingText = submitButton.querySelector('.loading-text');
	const loadingSpinner = submitButton.querySelector('.loading-spinner');

	// Debounce function
	function debounce(func, wait) {
		let timeout;
		return function executedFunction(...args) {
			const later = () => {
				clearTimeout(timeout);
				func(...args);
			};
			clearTimeout(timeout);
			timeout = setTimeout(later, wait);
		};
	}

	// Basic client-side validation
	function validateForm(formData) {
		const email = formData.get('email');
		const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
		if (!emailRegex.test(email)) {
			showToast(translations.invalidEmail || 'Invalid email format', true);
			return false;
		}
		return true;
	}

	// Set loading state
	function setLoading(isLoading) {
		submitButton.disabled = isLoading;
		loadingText.classList.toggle('hidden', isLoading);
		loadingSpinner.classList.toggle('hidden', !isLoading);
	}

	window.onSubmit = debounce(async (token) => {
		try {
			setLoading(true);
			const formData = new FormData(form);

			if (!validateForm(formData)) {
				setLoading(false);
				return;
			}

			if (!token) {
				showToast(translations.recaptchaFailed, true);
				setLoading(false);
				return;
			}

			const recaptchaResponse = await fetch('/api/recaptcha', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({ token }),
			});

			const gResponse = await recaptchaResponse.json();

			if (!gResponse.success) {
				const errorMessage = gResponse['error-codes']?.join(', ') || 'Verification failed';
				showToast(`${translations.recaptchaError} ${errorMessage}`, true);
				setLoading(false);
				return;
			}

			const data = Object.fromEntries(formData.entries());
			const response = await fetch(contactForm, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'yap-token': contactFormToken,
				},
				body: JSON.stringify(data),
			});

			if (response.ok) {
				showToast(translations.messageSent);
				form.reset();
			} else {
				throw new Error(translations.formSubmissionFailed);
			}
		} catch (error) {
			showToast(translations.formError, true);
			console.error(error);
		} finally {
			setLoading(false);
			grecaptcha.reset();
		}
	}, 500);

	// Add form validation listeners
	form.querySelectorAll('input, textarea').forEach((field) => {
		field.addEventListener('invalid', (e) => {
			e.preventDefault();
			field.classList.add('border-red-500');
		});

		field.addEventListener('input', () => {
			field.classList.remove('border-red-500');
		});
	});
</script> -->

<style>
	#toast-notification {
		transform: translateX(0);
	}

	#toast-notification.invisible {
		transform: translateX(100%);
	}

	.border-red-500 {
		border-color: rgb(239, 68, 68);
	}
</style>
