---
export const prerender = true;

import PageHeadline from "@/components/atoms/PageHeadline.astro";
import BlogGridContainer from "@/components/molecules/BlogGridContainer.astro";
import Pagination from "@/components/molecules/Pagination.astro";
import Footer from "@/components/organisms/Footer.astro";
import { getArticles } from "@/core/article";
import { getTags } from "@/core/tag";
import { type Lang, LOCALES, useTranslations } from "@/i18n";
import Layout from "@/layouts/Layout.astro";

export async function getStaticPaths() {
	const paths = [];
	const allArticles = await getArticles();

	for (const lang of Object.keys(LOCALES)) {
		const tags = await getTags({ lang: lang as Lang });
		for (const tag of tags) {
			const tagArticles = allArticles.filter(
				(article) =>
					article.tags.some((tagItem) => tagItem.slug === tag.slug) &&
					article.id.startsWith(`${lang}/`),
			);

			if (tagArticles.length > 0) {
				paths.push({
					params: {
						lang: lang,
						tag: tag.slug,
					},
					props: { tag },
				});
			}
		}
	}
	return paths;
}

const { lang, tag: tagSlug } = Astro.params;
const { tag } = Astro.props;

const t = useTranslations(lang as Lang);

const allArticles = await getArticles();
const tagArticles = allArticles
	.filter(
		(article) =>
			article.tags.some((tagItem) => tagItem.slug === tagSlug) &&
			article.id.startsWith(`${lang}/`),
	)
	.sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf());

const postsPerPage = 16;
const totalPages = Math.ceil(tagArticles.length / postsPerPage);
const basePath = `/${lang}/tag/${tagSlug}/page`;
const indexUrl = `/${lang}/tag/${tagSlug}`;

const title = `${t("tag.title")}: ${tag.title}`;
---

<Layout {title}>
	<div class="container mx-auto px-4 pt-24">
		<PageHeadline title={tag.title}>
			<p class="text-xl">
				{t("tag.description", { tag: tag.title })}
			</p>
		</PageHeadline>
		<BlogGridContainer posts={tagArticles.slice(0, postsPerPage)} />
		<Pagination
			currentPage={1}
			lastPage={totalPages}
			urlPrev={null}
			urlNext={totalPages > 1 ? `${basePath}/2` : null}
			basePath={basePath}
			maxDisplayedPages={5}
			firstPageUrl={indexUrl}
		/>
	</div>
	<Footer />
</Layout>