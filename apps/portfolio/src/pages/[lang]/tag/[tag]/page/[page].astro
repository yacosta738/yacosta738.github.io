---
export const prerender = true;

import PageHeadline from "@/components/atoms/PageHeadline.astro";
import BlogGridContainer from "@/components/molecules/BlogGridContainer.astro";
import Pagination from "@/components/molecules/Pagination.astro";
import Footer from "@/components/organisms/Footer.astro";
import { getArticles } from "@/core/article";
import { getTags } from "@/core/tag";
import { type Lang, LOCALES, useTranslations } from "@/i18n";
import Layout from "@/layouts/Layout.astro";

export async function getStaticPaths() {
	const paths = [];
	const allArticles = await getArticles();
	const postsPerPage = 16;

	for (const lang of Object.keys(LOCALES)) {
		const tags = await getTags({ lang: lang as Lang });
		for (const tag of tags) {
			const tagArticles = allArticles
				.filter(
					(article) =>
						article.tags.some((tagItem) => tagItem.slug === tag.slug) &&
						article.id.startsWith(`${lang}/`),
				)
				.sort(
					(a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf(),
				);

			const totalPages = Math.ceil(tagArticles.length / postsPerPage);

			for (let i = 2; i <= totalPages; i++) {
				const pagePosts = tagArticles.slice(
					(i - 1) * postsPerPage,
					i * postsPerPage,
				);

				if (pagePosts.length > 0) {
					paths.push({
						params: {
							lang,
							tag: tag.slug,
							page: i.toString(),
						},
						props: {
							tag,
							page: {
								data: pagePosts,
								currentPage: i,
								lastPage: totalPages,
							},
						},
					});
				}
			}
		}
	}
	return paths;
}

const { lang, tag: tagSlug } = Astro.params;
const { tag, page } = Astro.props;
const t = useTranslations(lang as Lang);

const basePath = `/${lang}/tag/${tagSlug}/page`;
const indexUrl = `/${lang}/tag/${tagSlug}`;
const title = `${t("tag.title")}: ${tag.title}`;
---

<Layout {title}>
	<div class="container mx-auto px-4 pt-24">
		<PageHeadline title={tag.title}>
			<p class="text-xl">
				{t("tag.description", { tag: tag.title })}
			</p>
		</PageHeadline>
		<BlogGridContainer posts={page.data} />
		<Pagination
			currentPage={page.currentPage}
			lastPage={page.lastPage}
			urlPrev={page.currentPage > 2 ? `${basePath}/${page.currentPage - 1}` : indexUrl}
			urlNext={page.currentPage < page.lastPage ? `${basePath}/${page.currentPage + 1}` : null}
			basePath={basePath}
			maxDisplayedPages={5}
			firstPageUrl={indexUrl}
		/>
	</div>
	<Footer />
</Layout>