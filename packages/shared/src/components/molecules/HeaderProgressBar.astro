---
import type { HTMLAttributes } from "astro/types";
import SocialMediaShare from "@/components/molecules/SocialMediaShare.astro";
import { type Lang, useTranslations } from "@/i18n";
import { cn } from "@/lib/utils";
import ReadingTime from "../atoms/ReadingTime.astro";

interface Props extends HTMLAttributes<"div"> {
	title: string;
	description: string;
	url: string;
	tags: string[];
	minutesRead: string;
}

const currentLocale = Astro.currentLocale as Lang;
const t = useTranslations(currentLocale);
const {
	title,
	description,
	url = Astro.request.url,
	tags,
	minutesRead,
	...attr
} = Astro.props;
---

<div
	id="progress-bar"
	class={cn(
		"fixed -top-[80px] left-0 w-full h-22 px-4 lg:px-12 z-40 opacity-0 flex items-center justify-between gap-8 border-b border-transparent transition-all duration-[350ms] ease-in-out",
		"bg-background/75 backdrop-blur-md supports-[backdrop-filter]:bg-background-secondary/75",
		attr.class,
	)}
	data-progress-bar
>
	<div class="container mx-auto flex items-center justify-between h-full">
		<div class="flex items-center gap-2.5">
			<span
				class="font-inter text-sm md:text-xl font-semibold leading-[130%] tracking-tighter text-foreground"
			>
				{title}
			</span>
			<ReadingTime readingTime={minutesRead} currentLocale={currentLocale} />
		</div>
		<div class="hidden md:flex items-center justify-center">
			<SocialMediaShare
				title={title}
				description={description}
				url={url}
				tags={tags}
			/>
		</div>
	</div>

	<div class="absolute left-0 bottom-0 w-full h-1">
		<div
			id="progress-indicator"
			class="h-full w-0 bg-brand-accent dark:bg-brand-accent rounded-r-lg transition-all duration-150"
			aria-label={`${t("progress.aria.label")}: 0%`}
			role="progressbar"
			aria-valuenow="0"
			aria-valuemin="0"
			aria-valuemax="100"
			aria-valuetext={t("progress.aria.label")}
		>
		</div>
	</div>
</div>

<style is:global>
	/* Progress bar styles to match main header */
	#progress-bar {
		background-color: rgba(17,34,51,0.75);
		backdrop-filter: blur(16px);
		-webkit-backdrop-filter: blur(16px);
		border-bottom: 1px solid rgba(35,53,84,0.3);
	}

	:global(.dark) #progress-bar {
	background-color: rgba(17,34,51,0.75);
	border-bottom: 1px solid rgba(35,53,84,0.3);
	}

	/* Enhanced blur on hover to match main header */
	#progress-bar:hover {
		backdrop-filter: blur(20px);
		-webkit-backdrop-filter: blur(20px);
	}

	/* Respect user's motion preferences */
	@media (prefers-reduced-motion: reduce) {
		#progress-bar {
			transition: none !important;
		}
	}
</style>

<script>
	(() => {
		const CLEANUP_KEY = "__headerProgressBarCleanup";

		const cleanup = () => {
			const currentCleanup = window[CLEANUP_KEY];
			if (typeof currentCleanup === "function") {
				currentCleanup();
				window[CLEANUP_KEY] = undefined;
			}
		};

		const initialize = () => {
			cleanup();

			const progressBar = document.getElementById("progress-bar");
			const progressIndicator = document.getElementById("progress-indicator");

			if (!progressBar || !progressIndicator) {
				return;
			}

			let progressUpdateId: number | null = null;
			let cachedArticleRect: { top: number; height: number } | null = null;
			let cacheTime = 0;
			const CACHE_DURATION = 100;
			const headerHeight = 80;
			let isVisible = false;

			const getArticleRect = () => {
				const article = document.querySelector("article");
				if (!article) return null;

				const now = performance.now();
				if (!cachedArticleRect || now - cacheTime > CACHE_DURATION) {
					const scrollY = window.scrollY;
					const articleRect = article.getBoundingClientRect();
					cachedArticleRect = {
						top: articleRect.top + scrollY,
						height: article.scrollHeight,
					};
					cacheTime = now;
				}

				return cachedArticleRect;
			};

			const updateProgress = () => {
				const articleRect = getArticleRect();
				if (!articleRect) return;

				const scrollY = window.scrollY;
				const windowHeight = window.innerHeight;
				const scrollStart = articleRect.top;
				const scrollEnd = articleRect.top + articleRect.height - windowHeight;
				const scrollDistance = scrollEnd - scrollStart;

				if (scrollDistance <= 0) return;

				const progress = Math.max(0, Math.min(100, ((scrollY - scrollStart) / scrollDistance) * 100));
				const roundedProgress = Math.round(progress);

				progressIndicator.style.width = `${progress}%`;
				progressIndicator.setAttribute("aria-valuenow", roundedProgress.toString());
				progressIndicator.setAttribute("aria-label", `Reading progress: ${roundedProgress}%`);
			};

			const updateVisibility = () => {
				const articleRect = getArticleRect();
				if (!articleRect) return;

				const scrollY = window.scrollY;
				const shouldShow =
					scrollY > headerHeight &&
					scrollY < articleRect.top + articleRect.height - window.innerHeight / 4;

				if (shouldShow && !isVisible) {
					progressBar.style.top = "0";
					progressBar.style.opacity = "1";
					progressBar.style.transform = "translateY(0)";
					isVisible = true;
				} else if (!shouldShow && isVisible) {
					progressBar.style.top = "-80px";
					progressBar.style.opacity = "0";
					progressBar.style.transform = "translateY(-100%)";
					isVisible = false;
				}
			};

			const handleScroll = () => {
				if (progressUpdateId) return;

				progressUpdateId = requestAnimationFrame(() => {
					updateProgress();
					updateVisibility();
					progressUpdateId = null;
				});
			};

			const handleResize = () => {
				cachedArticleRect = null;
				cacheTime = 0;
				handleScroll();
			};

			progressBar.style.position = "fixed";
			progressBar.style.top = "-80px";
			progressBar.style.opacity = "0";
			progressBar.style.transition = "all 0.3s ease-in-out";
			progressBar.style.zIndex = "40";

			window.addEventListener("scroll", handleScroll, { passive: true });
			window.addEventListener("resize", handleResize, { passive: true });
			handleScroll();

			window[CLEANUP_KEY] = () => {
				window.removeEventListener("scroll", handleScroll);
				window.removeEventListener("resize", handleResize);

				if (progressUpdateId) {
					cancelAnimationFrame(progressUpdateId);
					progressUpdateId = null;
				}
			};
		};

		document.addEventListener("astro:page-load", initialize);
		document.addEventListener("astro:before-preparation", cleanup);
		initialize();
	})();
</script>
