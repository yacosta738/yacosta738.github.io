!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("immutable")):"function"==typeof define&&define.amd?define("NetlifyCmsLibAuth",["immutable"],e):"object"==typeof exports?exports.NetlifyCmsLibAuth=e(require("immutable")):t.NetlifyCmsLibAuth=e(t.NetlifyCmsDefaultExports.Immutable)}(window,(function(t){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var o=e[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)r.d(n,o,function(e){return t[e]}.bind(null,o));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=33)}([function(t,e,r){var n=r(2),o=r(22),i=r(5),s=r(6),c=r(27),a=r(8),u=r(9);t.exports=function(t,e,r){if((t=u(t))&&(r||void 0===e))return o(t);if(!t||!(e=n(e)))return t;var f=a(t),l=a(e),h=c(f,l),p=s(f,l)+1;return i(f,h,p).join("")}},function(t,e,r){var n=r(2),o=r(5),i=r(6),s=r(8),c=r(9),a=r(4);t.exports=function(t,e,r){if((t=c(t))&&(r||void 0===e))return t.slice(0,a(t)+1);if(!t||!(e=n(e)))return t;var u=s(t),f=i(u,s(e))+1;return o(u,0,f).join("")}},function(t,e,r){var n=r(3),o=r(15),i=r(16),s=r(17),c=n?n.prototype:void 0,a=c?c.toString:void 0;t.exports=function t(e){if("string"==typeof e)return e;if(i(e))return o(e,t)+"";if(s(e))return a?a.call(e):"";var r=e+"";return"0"==r&&1/e==-1/0?"-0":r}},function(t,e,r){var n=r(12).Symbol;t.exports=n},function(t,e){var r=/\s/;t.exports=function(t){for(var e=t.length;e--&&r.test(t.charAt(e)););return e}},function(t,e,r){var n=r(23);t.exports=function(t,e,r){var o=t.length;return r=void 0===r?o:r,!e&&r>=o?t:n(t,e,r)}},function(t,e,r){var n=r(7);t.exports=function(t,e){for(var r=t.length;r--&&n(e,t[r],0)>-1;);return r}},function(t,e,r){var n=r(24),o=r(25),i=r(26);t.exports=function(t,e,r){return e==e?i(t,e,r):n(t,o,r)}},function(t,e,r){var n=r(28),o=r(29),i=r(30);t.exports=function(t){return o(t)?i(t):n(t)}},function(t,e,r){var n=r(2);t.exports=function(t){return null==t?"":n(t)}},function(e,r){e.exports=t},function(t,e,r){var n=r(31),o=r(32);t.exports=function(t,e,r){var i=e&&r||0;"string"==typeof t&&(e="binary"===t?new Array(16):null,t=null);var s=(t=t||{}).random||(t.rng||n)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,e)for(var c=0;c<16;++c)e[i+c]=s[c];return e||o(s)}},function(t,e,r){var n=r(13),o="object"==typeof self&&self&&self.Object===Object&&self,i=n||o||Function("return this")();t.exports=i},function(t,e,r){(function(e){var r="object"==typeof e&&e&&e.Object===Object&&e;t.exports=r}).call(this,r(14))},function(t,e){var r;r=function(){return this}();try{r=r||new Function("return this")()}catch(t){"object"==typeof window&&(r=window)}t.exports=r},function(t,e){t.exports=function(t,e){for(var r=-1,n=null==t?0:t.length,o=Array(n);++r<n;)o[r]=e(t[r],r,t);return o}},function(t,e){var r=Array.isArray;t.exports=r},function(t,e,r){var n=r(18),o=r(21);t.exports=function(t){return"symbol"==typeof t||o(t)&&"[object Symbol]"==n(t)}},function(t,e,r){var n=r(3),o=r(19),i=r(20),s=n?n.toStringTag:void 0;t.exports=function(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":s&&s in Object(t)?o(t):i(t)}},function(t,e,r){var n=r(3),o=Object.prototype,i=o.hasOwnProperty,s=o.toString,c=n?n.toStringTag:void 0;t.exports=function(t){var e=i.call(t,c),r=t[c];try{t[c]=void 0;var n=!0}catch(t){}var o=s.call(t);return n&&(e?t[c]=r:delete t[c]),o}},function(t,e){var r=Object.prototype.toString;t.exports=function(t){return r.call(t)}},function(t,e){t.exports=function(t){return null!=t&&"object"==typeof t}},function(t,e,r){var n=r(4),o=/^\s+/;t.exports=function(t){return t?t.slice(0,n(t)+1).replace(o,""):t}},function(t,e){t.exports=function(t,e,r){var n=-1,o=t.length;e<0&&(e=-e>o?0:o+e),(r=r>o?o:r)<0&&(r+=o),o=e>r?0:r-e>>>0,e>>>=0;for(var i=Array(o);++n<o;)i[n]=t[n+e];return i}},function(t,e){t.exports=function(t,e,r,n){for(var o=t.length,i=r+(n?1:-1);n?i--:++i<o;)if(e(t[i],i,t))return i;return-1}},function(t,e){t.exports=function(t){return t!=t}},function(t,e){t.exports=function(t,e,r){for(var n=r-1,o=t.length;++n<o;)if(t[n]===e)return n;return-1}},function(t,e,r){var n=r(7);t.exports=function(t,e){for(var r=-1,o=t.length;++r<o&&n(e,t[r],0)>-1;);return r}},function(t,e){t.exports=function(t){return t.split("")}},function(t,e){var r=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]");t.exports=function(t){return r.test(t)}},function(t,e){var r="[\\ud800-\\udfff]",n="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",o="\\ud83c[\\udffb-\\udfff]",i="[^\\ud800-\\udfff]",s="(?:\\ud83c[\\udde6-\\uddff]){2}",c="[\\ud800-\\udbff][\\udc00-\\udfff]",a="(?:"+n+"|"+o+")"+"?",u="[\\ufe0e\\ufe0f]?"+a+("(?:\\u200d(?:"+[i,s,c].join("|")+")[\\ufe0e\\ufe0f]?"+a+")*"),f="(?:"+[i+n+"?",n,s,c,r].join("|")+")",l=RegExp(o+"(?="+o+")|"+f+u,"g");t.exports=function(t){return t.match(l)||[]}},function(t,e){var r="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(r){var n=new Uint8Array(16);t.exports=function(){return r(n),n}}else{var o=new Array(16);t.exports=function(){for(var t,e=0;e<16;e++)0==(3&e)&&(t=4294967296*Math.random()),o[e]=t>>>((3&e)<<3)&255;return o}}},function(t,e){for(var r=[],n=0;n<256;++n)r[n]=(n+256).toString(16).substr(1);t.exports=function(t,e){var n=e||0,o=r;return[o[t[n++]],o[t[n++]],o[t[n++]],o[t[n++]],"-",o[t[n++]],o[t[n++]],"-",o[t[n++]],o[t[n++]],"-",o[t[n++]],o[t[n++]],"-",o[t[n++]],o[t[n++]],o[t[n++]],o[t[n++]],o[t[n++]],o[t[n++]]].join("")}},function(t,e,r){"use strict";r.r(e),r.d(e,"NetlifyCmsLibAuth",(function(){return S})),r.d(e,"NetlifyAuthenticator",(function(){return u})),r.d(e,"ImplicitAuthenticator",(function(){return w})),r.d(e,"PkceAuthenticator",(function(){return P}));var n=r(0),o=r.n(n),i=r(1),s=r.n(i);class c{constructor(t){this.err=t}toString(){return this.err&&this.err.message}}const a={github:{width:960,height:600},gitlab:{width:960,height:600},bitbucket:{width:960,height:500},email:{width:500,height:400}};var u=class{constructor(t={}){this.site_id=t.site_id||null,this.base_url=s()(t.base_url,"/")||"https://api.netlify.com",this.auth_endpoint=o()(t.auth_endpoint,"/")||"auth"}handshakeCallback(t,e){const r=n=>{if(n.data==="authorizing:"+t.provider&&n.origin===this.base_url)return window.removeEventListener("message",r,!1),window.addEventListener("message",this.authorizeCallback(t,e),!1),this.authWindow.postMessage(n.data,n.origin)};return r}authorizeCallback(t,e){const r=n=>{if(n.origin===this.base_url){if(0===n.data.indexOf("authorization:"+t.provider+":success:")){const o=JSON.parse(n.data.match(new RegExp("^authorization:"+t.provider+":success:(.+)$"))[1]);window.removeEventListener("message",r,!1),this.authWindow.close(),e(null,o)}if(0===n.data.indexOf("authorization:"+t.provider+":error:")){const o=JSON.parse(n.data.match(new RegExp("^authorization:"+t.provider+":error:(.+)$"))[1]);window.removeEventListener("message",r,!1),this.authWindow.close(),e(new c(o))}}};return r}getSiteID(){if(this.site_id)return this.site_id;const t=document.location.host.split(":")[0];return"localhost"===t?"cms.netlify.com":t}authenticate(t,e){const{provider:r}=t,n=this.getSiteID();if(!r)return e(new c({message:"You must specify a provider when calling netlify.authenticate"}));if(!n)return e(new c({message:"You must set a site_id with netlify.configure({site_id: 'your-site-id'}) to make authentication work from localhost"}));const o=a[r]||a.github,i=screen.width/2-o.width/2,s=screen.height/2-o.height/2;window.addEventListener("message",this.handshakeCallback(t,e),!1);let u=`${this.base_url}/${this.auth_endpoint}?provider=${t.provider}&site_id=${n}`;t.scope&&(u+="&scope="+t.scope),!0===t.login&&(u+="&login=true"),t.beta_invite&&(u+="&beta_invite="+t.beta_invite),t.invite_code&&(u+="&invite_code="+t.invite_code),this.authWindow=window.open(u,"Netlify Authorization",`width=${o.width}, height=${o.height}, top=${s}, left=${i}`),this.authWindow.focus()}refresh(t,e){const{provider:r,refresh_token:n}=t,o=this.getSiteID(),i=e||Promise.reject.bind(Promise);if(!r||!n)return i(new c({message:"You must specify a provider and refresh token when calling netlify.refresh"}));if(!o)return i(new c({message:"You must set a site_id with netlify.configure({site_id: 'your-site-id'}) to make token refresh work from localhost"}));const s=`${this.base_url}/${this.auth_endpoint}/refresh?provider=${r}&site_id=${o}&refresh_token=${n}`,a=fetch(s,{method:"POST",body:""}).then(t=>t.json());if(!e)return a;a.then(t=>e(null,t)).catch(e)}},f=r(10),l=r(11),h=r.n(l);function p(){const t=h()();return window.sessionStorage.setItem("netlify-cms-auth",JSON.stringify({nonce:t})),t}function d(t){const e=window.sessionStorage.getItem("netlify-cms-auth"),r=e&&JSON.parse(e).nonce;return window.localStorage.removeItem("netlify-cms-auth"),t===r}function m(){return"https:"!==document.location.protocol&&"localhost"!==document.location.hostname&&"127.0.0.1"!==document.location.hostname}const y=["access_token"];function g(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function b(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function v(t,e){if(null==t)return{};var r,n,o=function(t,e){if(null==t)return{};var r,n,o={},i=Object.keys(t);for(n=0;n<i.length;n++)r=i[n],e.indexOf(r)>=0||(o[r]=t[r]);return o}(t,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(n=0;n<i.length;n++)r=i[n],e.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(t,r)&&(o[r]=t[r])}return o}class w{constructor(t={}){const e=s()(t.base_url,"/"),r=o()(t.auth_endpoint,"/");this.auth_url=`${e}/${r}`,this.appID=t.app_id,this.clearHash=t.clearHash}authenticate(t,e){if(m())return e(new Error("Cannot authenticate over insecure protocol!"));const r=new URL(this.auth_url);r.searchParams.set("client_id",this.appID),r.searchParams.set("redirect_uri",document.location.origin+document.location.pathname),r.searchParams.set("response_type","token"),r.searchParams.set("scope",t.scope),null!=t.prompt&&null!=t.prompt&&r.searchParams.set("prompt",t.prompt),null!=t.resource&&null!=t.resource&&r.searchParams.set("resource",t.resource);const n=JSON.stringify({auth_type:"implicit",nonce:p()});r.searchParams.set("state",n),document.location.assign(r.href)}completeAuth(t){const e=new URLSearchParams(document.location.hash.replace(/^#?\/?/,""));if(!e.has("access_token")&&!e.has("error"))return;this.clearHash();const r=Object(f.Map)(e.entries()),{nonce:n}=JSON.parse(r.get("state"));if(!d(n))return t(new Error("Invalid nonce"));if(r.has("error"))return t(new Error(`${r.get("error")}: ${r.get("error_description")}`));if(r.has("access_token")){const e=r.toJS(),{access_token:n}=e;t(null,function(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?g(Object(r),!0).forEach((function(e){b(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):g(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}({token:n},v(e,y)))}}}function _(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function O(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}async function j(t){const e=await async function(t){const e=(new TextEncoder).encode(t),r=await window.crypto.subtle.digest("SHA-256",e);return String.fromCharCode(...new Uint8Array(r))}(t);return btoa(e).split("=")[0].replace(/\+/g,"-").replace(/\//g,"_")}function x(){const t=function(){const t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-.";return Array.from(window.crypto.getRandomValues(new Uint8Array(128))).map(e=>t[e%t.length]).join("")}();return window.sessionStorage.setItem("netlify-cms-pkce-verifier-code",t),t}class P{constructor(t={}){const e=s()(t.base_url,"/"),r=o()(t.auth_endpoint,"/"),n=o()(t.auth_token_endpoint,"/");this.auth_url=`${e}/${r}`,this.auth_token_url=`${e}/${n}`,this.appID=t.app_id}async authenticate(t,e){if(m())return e(new Error("Cannot authenticate over insecure protocol!"));const r=new URL(this.auth_url);r.searchParams.set("client_id",this.appID),r.searchParams.set("redirect_uri",document.location.origin+document.location.pathname),r.searchParams.set("response_type","code"),r.searchParams.set("scope",t.scope);const n=JSON.stringify({auth_type:"pkce",nonce:p()});r.searchParams.set("state",n),r.searchParams.set("code_challenge_method","S256");const o=x(),i=await j(o);r.searchParams.set("code_challenge",i),document.location.assign(r.href)}async completeAuth(t){const e=new URLSearchParams(document.location.search);if(window.history.replaceState(null,"",document.location.pathname),!e.has("code")&&!e.has("error"))return;const{nonce:r}=JSON.parse(e.get("state"));if(!d(r))return t(new Error("Invalid nonce"));if(e.has("error"))return t(new Error(`${e.get("error")}: ${e.get("error_description")}`));if(e.has("code")){const r=e.get("code"),n=new URL(this.auth_token_url);n.searchParams.set("client_id",this.appID),n.searchParams.set("code",r),n.searchParams.set("grant_type","authorization_code"),n.searchParams.set("redirect_uri",document.location.origin+document.location.pathname),n.searchParams.set("code_verifier",window.sessionStorage.getItem("netlify-cms-pkce-verifier-code")),window.sessionStorage.removeItem("netlify-cms-pkce-verifier-code");const o=await fetch(n.href,{method:"POST"}),i=await o.json();t(null,function(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?_(Object(r),!0).forEach((function(e){O(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):_(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}({token:i.access_token},i))}}}const S={NetlifyAuthenticator:u,ImplicitAuthenticator:w,PkceAuthenticator:P}}]).NetlifyCmsLibAuth}));
//# sourceMappingURL=netlify-cms-lib-auth.js.map