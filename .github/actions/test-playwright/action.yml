name: 'E2E Tests (Playwright)'
description: 'Run Playwright E2E tests with intelligent browser caching'
author: 'yacosta738'

inputs:
  app:
    description: 'App to test (portfolio/blog)'
    required: false
    default: 'portfolio'
  browser:
    description: 'Browser to test (chromium/firefox/webkit/all)'
    required: false
    default: 'chromium'
  headed:
    description: 'Run in headed mode'
    required: false
    default: 'false'
  upload-results:
    description: 'Upload test results and traces'
    required: false
    default: 'true'

outputs:
  tests-status:
    description: 'Test execution status'
    value: ${{ steps.run-tests.outputs.status }}
  report-path:
    description: 'Path to test report'
    value: apps/${{ inputs.app }}/playwright-report

runs:
  using: "composite"
  steps:
    - name: Get Playwright version
      id: playwright-version
      shell: bash
      working-directory: apps/${{ inputs.app }}
      run: |
        VERSION=$(jq -r '.devDependencies["@playwright/test"] // .dependencies["@playwright/test"] // "latest"' package.json)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸŽ­ Playwright version: $VERSION"
    - name: Install dependencies
      shell: bash
      working-directory: apps/${{ inputs.app }}
      run: pnpm install --frozen-lockfile
    - name: Cache Playwright browsers
      id: playwright-cache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}-${{ inputs.browser }}
        restore-keys: |
          ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}-
          ${{ runner.os }}-playwright-

    - name: Install Playwright browsers
      if: steps.playwright-cache.outputs.cache-hit != 'true'
      shell: bash
      working-directory: apps/${{ inputs.app }}
      env:
        BROWSER_INPUT: ${{ inputs.browser }}
      run: |
        echo "ðŸ“¥ Installing Playwright browsers..."
        
        if [ "$BROWSER_INPUT" == "all" ]; then
          pnpm exec playwright install --with-deps
        else
          pnpm exec playwright install --with-deps "$BROWSER_INPUT"
        fi

    - name: Ensure Playwright browsers (cached)
      if: steps.playwright-cache.outputs.cache-hit == 'true'
      shell: bash
      working-directory: apps/${{ inputs.app }}
      env:
        BROWSER_INPUT: ${{ inputs.browser }}
      run: |
        echo "â™»ï¸ Using cached browsers, validating browser binaries and dependencies..."
        
        if [ "$BROWSER_INPUT" == "all" ]; then
          pnpm exec playwright install
          pnpm exec playwright install-deps
        else
          pnpm exec playwright install "$BROWSER_INPUT"
          pnpm exec playwright install-deps "$BROWSER_INPUT"
        fi

    - name: Run Playwright tests
      id: run-tests
      shell: bash
      working-directory: apps/${{ inputs.app }}
      env:
        CI: true
        PW_USE_PREVIEW: '1'
        BROWSER_INPUT: ${{ inputs.browser }}
        HEADED_INPUT: ${{ inputs.headed }}
      run: |
        echo "ðŸŽ­ Running E2E tests..."
        
        EXTRA_ARGS=""
        if [ "$HEADED_INPUT" == "true" ]; then
          EXTRA_ARGS="--headed"
        fi
        
        if [ "$BROWSER_INPUT" == "all" ]; then
          pnpm test:e2e $EXTRA_ARGS
        else
          pnpm test:e2e --project="$BROWSER_INPUT" $EXTRA_ARGS
        fi
        
        STATUS=$?
        
        if [ $STATUS -eq 0 ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… All tests passed"
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "âŒ Some tests failed"
          exit 1
        fi

    - name: Upload test results
      if: always() && inputs.upload-results == 'true'
      uses: actions/upload-artifact@v7
      with:
        name: playwright-report-${{ inputs.app }}-${{ inputs.browser }}-${{ github.run_number }}
        path: apps/${{ inputs.app }}/playwright-report/
        retention-days: 30
        if-no-files-found: warn

    - name: Upload test traces
      if: failure() && inputs.upload-results == 'true'
      uses: actions/upload-artifact@v7
      with:
        name: playwright-traces-${{ inputs.app }}-${{ inputs.browser }}-${{ github.run_number }}
        path: apps/${{ inputs.app }}/test-results/
        retention-days: 30
        if-no-files-found: warn

    - name: Generate test summary
      if: always()
      shell: bash
      env:
        APP_INPUT: ${{ inputs.app }}
        BROWSER_INPUT: ${{ inputs.browser }}
        HEADED_INPUT: ${{ inputs.headed }}
        TEST_STATUS: ${{ steps.run-tests.outputs.status }}
      run: |
        if [ "$TEST_STATUS" == "success" ]; then
          STATUS_TEXT="âœ… Passed"
        else
          STATUS_TEXT="âŒ Failed"
        fi

        if [ "$HEADED_INPUT" == "true" ]; then
          MODE_TEXT="Headed"
        else
          MODE_TEXT="Headless"
        fi

        echo "## ðŸŽ­ E2E Tests Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **App**: $APP_INPUT" >> $GITHUB_STEP_SUMMARY
        echo "- **Browser**: $BROWSER_INPUT" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: $STATUS_TEXT" >> $GITHUB_STEP_SUMMARY
        echo "- **Mode**: $MODE_TEXT" >> $GITHUB_STEP_SUMMARY
        
        # Try to extract test statistics
        if [ -f "apps/$APP_INPUT/playwright-report/index.html" ]; then
          echo "- **Report**: Available in artifacts" >> $GITHUB_STEP_SUMMARY
        fi
