name: 'Build API (Cloudflare Workers)'
description: 'Validate and build Cloudflare Workers API with Wrangler'
author: 'yacosta738'

inputs:
  dry-run:
    description: 'Run in dry-run mode (validation only)'
    required: false
    default: 'true'

outputs:
  validation-status:
    description: 'Validation status'
    value: ${{ steps.validate.outputs.status }}

runs:
  using: "composite"
  steps:
    - name: Cache Wrangler
      uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb
      with:
        path: |
          apps/api/node_modules/.cache/wrangler
          ~/.cache/wrangler
        key: ${{ runner.os }}-wrangler-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-wrangler-

    - name: Install dependencies
      shell: bash
      working-directory: apps/api
      run: pnpm install --frozen-lockfile

    - name: Validate Wrangler configuration
      id: validate
      shell: bash
      working-directory: apps/api
      run: |
        echo "ðŸ” Validating Wrangler configuration..."
        
        if [ "${{ inputs.dry-run }}" == "true" ]; then
          echo "Running dry-run validation..."
          pnpm build
          STATUS=$?
        else
          echo "Skipping dry-run (deploy mode)"
          STATUS=0
        fi
        
        if [ $STATUS -eq 0 ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… Configuration valid"
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "âŒ Configuration invalid"
          exit 1
        fi

    - name: Type generation
      shell: bash
      working-directory: apps/api
      run: |
        echo "ðŸ“ Generating Cloudflare types..."
        pnpm cf-typegen || echo "âš ï¸ Type generation failed (non-fatal)"

    - name: Generate build summary
      shell: bash
      run: |
        echo "## ðŸš€ API Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: âœ… ${{ steps.validate.outputs.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Mode**: ${{ inputs.dry-run == 'true' && 'Validation' || 'Deploy' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
