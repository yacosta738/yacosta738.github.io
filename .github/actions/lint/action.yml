name: 'Lint & Type Check'
description: 'Run Biome linting and TypeScript type checking'
author: 'yacosta738'

inputs:
  fix:
    description: 'Auto-fix issues (for local use)'
    required: false
    default: 'false'
  check-astro:
    description: 'Run Astro check'
    required: false
    default: 'true'

outputs:
  biome-status:
    description: 'Biome check status'
    value: ${{ steps.biome.outputs.status }}
  astro-status:
    description: 'Astro check status'
    value: ${{ steps.astro.outputs.status }}

runs:
  using: "composite"
  steps:
    - name: Setup Biome
      uses: biomejs/setup-biome@v2
      with:
        version: latest

    - name: Cache Biome
      uses: actions/cache@v4
      with:
        path: |
          node_modules/.cache/biome
          .biome-cache
        key: ${{ runner.os }}-biome-${{ hashFiles('biome.json') }}
        restore-keys: |
          ${{ runner.os }}-biome-

    - name: Run Biome check
      id: biome
      shell: bash
      env:
        FIX_INPUT: ${{ inputs.fix }}
      run: |
        echo "ðŸ” Running Biome checks..."
        
        if [ "$FIX_INPUT" == "true" ]; then
          echo "ðŸ”§ Auto-fixing issues..."
          biome check . --write
          STATUS=$?
        else
          echo "Running checks in CI mode..."
          biome ci . --diagnostic-level=error
          STATUS=$?
        fi
        
        if [ $STATUS -eq 0 ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… Biome checks passed"
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "âŒ Biome checks failed"
          exit 1
        fi

    - name: Run Astro check
      id: astro
      if: inputs.check-astro == 'true'
      shell: bash
      run: |
        echo "ðŸ” Running Astro type checks for portfolio and blog..."
        pnpm install --frozen-lockfile --ignore-scripts || pnpm install
        pnpm --filter=portfolio check:astro
        pnpm --filter=blog check:astro
        STATUS=$?
        
        if [ $STATUS -eq 0 ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… Astro checks passed"
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "âŒ Astro checks failed"
          exit 1
        fi

    - name: Check accessibility
      shell: bash
      continue-on-error: true
      run: |
        echo "â™¿ Running accessibility checks for portfolio and blog..."
        pnpm --filter=portfolio check:a11y || echo "âš ï¸ Portfolio accessibility warnings found"
        pnpm --filter=blog check:a11y || echo "âš ï¸ Blog accessibility warnings found"

    - name: Generate lint summary
      shell: bash
      env:
        CHECK_ASTRO_INPUT: ${{ inputs.check-astro }}
        BIOME_STATUS: ${{ steps.biome.outputs.status }}
        ASTRO_STATUS: ${{ steps.astro.outputs.status }}
      run: |
        echo "## ðŸ” Lint & Type Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "$BIOME_STATUS" == "success" ]; then
          BIOME_ICON="âœ…"
        else
          BIOME_ICON="âŒ"
        fi
        echo "- **Biome**: $BIOME_ICON $BIOME_STATUS" >> $GITHUB_STEP_SUMMARY
        if [ "$CHECK_ASTRO_INPUT" == "true" ]; then
          if [ "$ASTRO_STATUS" == "success" ]; then
            ASTRO_ICON="âœ…"
          else
            ASTRO_ICON="âŒ"
          fi
          echo "- **Astro**: $ASTRO_ICON $ASTRO_STATUS" >> $GITHUB_STEP_SUMMARY
        fi
