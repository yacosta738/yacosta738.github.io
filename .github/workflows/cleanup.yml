name: Cleanup Caches

on:
  pull_request:
    types: [closed]
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Token
        uses: ./.github/actions/setup-token
        env:
          PBOT_GITHUB_TOKEN: ${{ secrets.PBOT_GITHUB_TOKEN }}

      - name: Install gh-actions-cache extension
        run: gh extension install actions/gh-actions-cache
        env:
          GH_TOKEN: ${{ env.PBOT_GITHUB_TOKEN }}

      - name: Cleanup caches
        run: |
          REPO="${{ github.repository }}"
          BRANCH="refs/pull/${{ github.event.pull_request.number }}/merge"
          
          echo "üîç Fetching cache keys for PR #${{ github.event.pull_request.number }}"
          CACHE_KEYS=$(gh actions-cache list -R "$REPO" -B "$BRANCH" --limit 100 | cut -f 1)
          
          if [ -z "$CACHE_KEYS" ]; then
            echo "‚úÖ No caches to delete"
            exit 0
          fi
          
          CACHE_COUNT=$(echo "$CACHE_KEYS" | wc -l | tr -d ' ')
          echo "üóëÔ∏è  Deleting $CACHE_COUNT cache(s)..."
          
          set +e
          echo "$CACHE_KEYS" | while read -r key; do
            if [ -n "$key" ]; then
              gh actions-cache delete "$key" -R "$REPO" -B "$BRANCH" --confirm || true
            fi
          done
          
          echo "‚úÖ Cleanup completed"
        env:
          GH_TOKEN: ${{ env.PBOT_GITHUB_TOKEN }}
