name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '22'

jobs:
  test:
    name: üß™ Pre-Release Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup monorepo
        uses: ./.github/actions/setup
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run lint
        uses: ./.github/actions/lint

      - name: Run unit tests
        uses: ./.github/actions/test-unit
        with:
          project: all
          coverage: 'true'

      - name: Build all projects
        run: pnpm build

  release:
    name: üöÄ Semantic Release
    runs-on: ubuntu-latest
    needs: [test]
    timeout-minutes: 15
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup monorepo
        uses: ./.github/actions/setup
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Verify authentication
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "üîê Verifying authentication tokens (presence only)..."
          # Do NOT print token values ‚Äî only check presence via environment variables

          if [ -z "$GITHUB_TOKEN" ]; then
            echo "::error::Missing required secret GITHUB_TOKEN"
            exit 1
          else
            echo "- GITHUB_TOKEN is set"
          fi

          if [ -z "$NPM_TOKEN" ]; then
            echo "::error::Missing required secret NPM_TOKEN"
            exit 1
          else
            echo "- NPM_TOKEN is set"
          fi

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          echo "üöÄ Running semantic-release..."
          pnpm semantic-release

      - name: Release summary
        if: success()
        run: |
          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
          ## üéâ Release Complete

          ‚úÖ New version released successfully!

          Check the [Releases page](https://github.com/${{ github.repository }}/releases) for details.
          EOF

  post-release:
    name: üì¢ Post-Release
    runs-on: ubuntu-latest
    needs: [release]
    if: success()
    timeout-minutes: 5
    steps:
      - name: Post-release tasks
        run: |
          echo "‚úÖ Release workflow completed!"
          echo "üìù Changelog updated"
          echo "üè∑Ô∏è Git tag created"
          echo "üì¶ GitHub Release published"
