name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '22'

jobs:
  test:
    name: ğŸ§ª Pre-Release Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup monorepo
        uses: ./.github/actions/setup
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run lint
        uses: ./.github/actions/lint

      - name: Run unit tests
        uses: ./.github/actions/test-unit
        with:
          project: all
          coverage: 'true'

      - name: Build all projects
        run: pnpm build

  release:
    name: ğŸš€ Semantic Release
    runs-on: ubuntu-latest
    needs: [test]
    timeout-minutes: 15
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup monorepo
        uses: ./.github/actions/setup
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Verify authentication
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "ğŸ” Verifying authentication tokens (presence only)..."
          # Do NOT print token values â€” only check presence via environment variables

          if [ -z "$GITHUB_TOKEN" ]; then
            echo "::error::Missing required secret GITHUB_TOKEN"
            exit 1
          else
            echo "- GITHUB_TOKEN is set"
          fi

          if [ -z "$NPM_TOKEN" ]; then
            echo "::error::Missing required secret NPM_TOKEN"
            exit 1
          else
            echo "- NPM_TOKEN is set"
          fi

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          echo "ğŸš€ Running semantic-release..."
          pnpm semantic-release

      - name: Create Release PR
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the version from package.json (updated by semantic-release)
          VERSION=$(node -p "require('./package.json').version")
          
          if [ -n "$VERSION" ]; then
            # Create release tag
            TAG_NAME="v$VERSION"
            
            # Configure git user for commits
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            # Add all changes and create commit
            git add -A
            git commit -m "chore(release): $VERSION [skip ci]" || echo "No changes to commit"
            
            # Create and push tag
            git tag -d $TAG_NAME 2>/dev/null || true
            git tag $TAG_NAME
            
            # Create release branch from current state (main with changes)
            RELEASE_BRANCH="release/$(echo $VERSION | sed 's/v//')"
            git checkout -b "$RELEASE_BRANCH"
            
            # Push release branch with tag
            git push origin "$RELEASE_BRANCH" --set-upstream
            git push origin "$TAG_NAME"
            
            # Create Pull Request
            gh pr create --base main --head "$RELEASE_BRANCH" \
              --title "Release $TAG_NAME" \
              --body "## Release $TAG_NAME\n\nThis PR contains the release changes created by Semantic Release.\n\nPlease review and merge this PR to complete the release."
            
            echo "âœ… Created PR for release $TAG_NAME"
          else
            echo "No version found, skipping PR creation"
            exit 1
          fi

      - name: Release summary
        if: success()
        run: |
          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
          ## ğŸ‰ Release Complete

          âœ… New version released successfully!

          Check the [Releases page](https://github.com/${{ github.repository }}/releases) for details.
          EOF

  post-release:
    name: ğŸ“¢ Post-Release
    runs-on: ubuntu-latest
    needs: [release]
    if: success()
    timeout-minutes: 5
    steps:
      - name: Post-release tasks
        run: |
          echo "âœ… Release workflow completed!"
          echo "ğŸ“ Changelog updated"
          echo "ğŸ·ï¸ Git tag created"
          echo "ğŸ“¦ GitHub Release published"
